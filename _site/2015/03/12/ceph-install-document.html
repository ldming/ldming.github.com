
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Ceph install document</title>
    <meta name="description" content="简单介绍Ceph文件系统的安装部署过程。">
    <meta name="author" content="Domain">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes//bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes//bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes//bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes//css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <div class="container">
        
<div class="page-header">
  <h1>Ceph install document </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>12 March 2015</span>
    </div>
    <div class="content">
      
<p>Ceph是一个基于对象的分布式文件存储系统，我们将其用于Totem对象代理数据库管理系统的底层数据存储。</p>

<p>Ceph集群包括四种类型的节点，client、Monitor、MDS和OSD，其中client对系统发出请求，Mon节点负责维护集群状态，包括monitor map、OSD map、pg map和crush map等，所有状态的变更都被记录；osd节点负责存储数据，数据复制，恢复，均衡，提供监控数据等；mds是可选组件，管理元数据，只有在使用ceph文件系统时才需要用到，负责userspace接口。</p>

<h2 id="section">安装环境</h2>

<ul>
  <li>操作系统：Ubuntu14.04 64位</li>
  <li>CPU：Intel 酷睿双核 1.8GHZ</li>
  <li>硬盘：120GB</li>
</ul>

<h2 id="section-1">编译安装</h2>

<ol>
  <li>
    <p>安装依赖包，如下：</p>

 	apt-get install autotools-dev autoconf automake cdbs g++ gcc git libatomic-ops-dev libboost-dev libcrypto++-dev libcrypto++ libedit-dev libexpat1-dev libfcgi-dev libfuse-dev libgoogle-perftools-dev libgtkmm-2.4-dev libtool pkg-config uuid-dev libkeyutils-dev uuid-dev libkeyutils-dev  btrfs-tools libblkid-dev libudev-dev libsnappy-dev libleveldb-dev libboost-thread-dev  libboost-program-options-dev libaio-dev
  </li>
  <li><code>./autogen.sh</code></li>
  <li><code>./configure --without-xfs</code>（此时如果还提示缺包，则安装指定的包，继续执行这一步，直到成功）</li>
  <li><code>sudo make</code></li>
  <li><code>sudo make install</code></li>
</ol>

<h2 id="section-2">目录结构</h2>

<p>安装完成后，默认的安装目录在 <code>/usr/local/</code> 目录下，分别对应如下：</p>

<ul>
  <li><code>/usr/local/bin</code> 所有可执行文件包括需要用到的工具，共33个</li>
  <li><code>/usr/local/etc/ceph/</code> 配置文件放置在目录下，包括两个配置文件 <code>ceph.conf</code> 和 <code>fetch_config</code></li>
  <li><code>/usr/local/share/doc/ceph/</code> 该目录下有两个配置文件样本，我们的配置文件需要从此处拷贝</li>
  <li><code>/usr/local/lib</code> 存放所有的动态加载库文件</li>
  <li><code>/var/lib/ceph/</code> 存放ceph相关组件的目录，包括Mon节点、OSD节点等的信息</li>
  <li><code>/etc/ceph/ceph.conf</code> 在etc目录下还会存放一个ceph配置文件，其用途随后介绍</li>
</ul>

<h2 id="mon">部署Mon节点</h2>

<ul>
  <li>
    <p>创建配置文件目录,与监控节点相关的信息保存在该目录下，需要在每个监控节点都创建该目录</p>

    <p><code>sudo mkdir –p /var/lib/ceph/mon</code></p>
  </li>
  <li>
    <p>使用uuidgen命令生成一个fsid，用来唯一标识一个cluster，如果产生的uuid为f649b128-963c-4802-ae17-5a76f36c4c76，则在ceph.conf中对应的配置参数如下：</p>

    <p><code>fsid = f649b128-963c-4802-ae17-5a76f36c4c76	</code></p>
  </li>
  <li>
    <p>选择合适的集群名，例如集群名为ceph，则配置文件名为ceph.conf (这里集群名与配置文件名是对应的)</p>
  </li>
  <li>
    <p>确定监控节点的名字</p>

    <p><code>hostname –s</code> #节点名为ceph1</p>

    <p>IP为	<code>192.168.1.94</code></p>

    <p>则对应配置文件中的参数为：</p>

    <p><code>mon initial members = ceph1</code></p>

    <p><code>mon host = ceph1</code></p>

    <p><code>mon addr = 192.168.1.94</code></p>
  </li>
  <li>
    <p>为集群创建一个keyring，并产生一个monitor密钥（secret key）</p>

    <p><code>ceph-authtool --create-keyring /tmp/ceph.mon.keyring --gen-key -n mon. --cap mon 'allow *'</code></p>
  </li>
  <li>
    <p>产生一个管理员keyring，产生一个client.admin用户，并为该用户添加一个keyring</p>

    <pre><code>  ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --set-uid=0 --cap mon 'allow *' --cap osd 'allow *' --cap mds 'allow'
</code></pre>
  </li>
  <li>
    <p>将client.admin的key添加至ceph.mon.keyring</p>

    <p><code>ceph-authtool /tmp/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring</code></p>
  </li>
  <li>
    <p>使用hostnames、host IP和fsid，产生一个monitor map，将其保存至/tmp/monmap</p>

    <pre><code>  monmaptool --create --add  ceph1 192.168.1.94  --fsid f649b128-963c-4802-ae17-5a76f36c4c76  /tmp/monmap 
</code></pre>

    <p>(如果有多个mon节点，则可以同时写多个节点的信息，类似<code>--add mon2 192.168.1.90 –add mon3 192.168.1.91</code>)</p>
  </li>
  <li>
    <p>创建监控节点数据目录</p>

    <p><code>sudo mkdir /var/lib/ceph/mon/{cluster-name}-{hostname}</code></p>

    <p><code>sudo mkdir /var/lib/ceph/mon/ceph-ceph1</code></p>
  </li>
  <li>
    <p>使用前面创建的监控和管理key，以及map数据，写入数据目录</p>

    <p><code>sudo ceph-mon --mkfs -i ceph1 --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring</code></p>
  </li>
  <li>
    <p>最后的ceph.conf内容类似如下：</p>

    <pre><code>  [global]
  fsid = f649b128-963c-4802-ae17-5a76f36c4c76
   	public network = 192.168.1.0/24
   	cluster network = 192.168.1.0/24
  pid file = /var/run/ceph/$name.pid
  auth client required = cephx
  auth service required = cephx
  auth cluster required = cephx
 
  [mon]
  mon initial members = ceph1
  mon host = ceph1
  mon addr = 192.168.1.94
  mon data = /var/lib/ceph/mon/$cluster-$id

  [mon.ceph1]
  host = cehp1
  mon addr = 192.168.1.94
</code></pre>
  </li>
  <li>
    <p>创建done文件，用于标识monitor已经创建并且准备好开始</p>

    <p><code>sudo touch /var/lib/ceph/mon/ceph-ceph1/done</code></p>
  </li>
  <li>
    <p>启动该Mon节点</p>

    <p><code>sudo /etc/init.d/ceph start ceph.ceph1</code></p>
  </li>
  <li>
    <p>如果要使该守护进程每次开机都启动，我们必须创建一个空的文件，如下：</p>

    <p><code>sudo touch /var/lib/ceph/mon/ceph-ceph1/upstart</code></p>
  </li>
</ul>

<h3 id="section-3">注意：</h3>
<p>在调用<code>/etc/init.d/ceph start mon.ceph1</code>启动<code>mon.ceph1</code>时会读取<code>/usr/local/etc/ceph/ceph.conf</code>这个配置文件，获取关于mon节点的一些信息，但是在使用<code>sudo ceph –s</code>这个命令时，同样也会读取配置文件，但此时读取配置文件却不是在<code>/usr/local/etc/ceph</code>这个目录下，而是在<code>/etc/ceph</code>这个目录下，因此我们需要将配置文件拷贝至该目录下一份，否则会报错，其提示如下：<code>Error initializing cluster client： Error</code>。</p>

<p>但是如果只有<code>/etc/ceph</code>下的配置文件，而没有<code>/usr/local/etc/ceph</code>下的配置文件，则在启动<code>mon.ceph1</code>时会提示该目录下没有找到对应的<code>ceph.conf</code>，个人猜想它们查找配置文件的目录应该是可以调整的。</p>

<p><strong>此时，如果配置成功的话，执行<code>ceph –s</code> 应该会输出类似以下的信息:</strong></p>

<pre><code>cluster f649b128-963c-4802-ae17-5a76f36c4c76
     health HEALTH_ERR 64 pgs stuck inactive; 64 pgs stuck unclean; no osds
     monmap e1: 1 ceph1 at {ceph1=192.168.1.94:6789/0}, election epoch 1, quorum 0 ceph1
     osdmap e22: 0 osds: 0 up, 0 in
      pgmap v69: 64 pgs, 1 pools, 0 bytes data, 0 objects
            0 kB used, 0 kB / 0 kB avail
                  64 creating
</code></pre>

<h2 id="osd">部署OSD节点</h2>

<ul>
  <li>
    <p>将key文件和ceph.conf拷贝至osd节点中，没有key则无法通讯</p>

    <p><code>scp ceph.conf ceph.client.admin.keyring 192.168.1.95:/etc/ceph</code></p>

    <p>此时，在每台机器上创建osd，需要使用一个uuid，执行以下命令uuidgen产生一个uuid</p>

    <p><code>ceph osd create {uuid}</code> 产生一个osd-number 0,1,2等，表示该osd-number=0,1,2等</p>
  </li>
  <li>
    <p>创建OSD数据目录</p>
  </li>
</ul>

 	<code>mkdir /var/lib/ceph/osd/ceph-0</code>

<ul>
  <li>
    <p>创建文件系统，并将其挂在至相应的数据目录</p>

    <p><code>sudo mkfs -t {fstype} /dev/{hdd}</code></p>

    <p><code>sudo mount -o user_xattr /dev/{hdd} /var/lib/ceph/osd/ceph-{osd-number}</code></p>

    <p>这里的<code>/dev/{hdd}</code>可以是磁盘分区，也可以是磁盘的逻辑分区（LVM）</p>
  </li>
  <li>
    <p>初始化数据目录</p>

    <p><code>sudo ceph-osd -i {osd-num} --mkfs --mkkey --osd-uuid [{uuid}] --cluster {cluster_name}</code></p>

    <p>注意这里需要用到我们之前创建的uuid</p>
  </li>
  <li>
    <p>注册osd认证key</p>

    <p><code>ceph auth add osd.0 osd 'allow *' mon 'allow profile osd' -i /var/lib/ceph/osd/ceph-0/keyring</code></p>
  </li>
  <li>
    <p>添加ceph node至crush map</p>

    <p><code>ceph osd crush add-bucket osd1 host</code> 这里的osd1为主机名</p>
  </li>
  <li>
    <p>添加ceph node至default root</p>

    <p><code>ceph osd crush move osd1 root=default</code> 这里的osd1为主机名</p>
  </li>
  <li>
    <p>添加osd至crush map</p>

    <p><code>ceph osd crush add osd.{osd_num}|{id-or-name} {weight} [{bucket-type}={bucket-name} ...]</code></p>

    <p><code>ceph osd crush add osd.0 1.0 host=osd1</code> 这里的osd1为主机名</p>
  </li>
  <li>
    <p>启动osd服务</p>

    <p><code>sudo /etc/init.d/ceph start osd.0</code></p>
  </li>
  <li>
    <p>添加服务 在每个	<code>/var/lib/ceph/osd/ceph-number</code> 目录下添加空白文件sysvinit</p>
  </li>
  <li>
    <p>最后，通过<code>ceph –s</code> 查看集群状态</p>

    <pre><code>  cluster b24d2b17-28f2-419a-923d-e05332e2ea58
       health HEALTH_WARN 32 pgs degraded; 32 pgs stuck degraded; 64 pgs stuck unclean; 32 pgs stuck undersized; 32 pgs undersized; too few pgs per osd (8 &lt; min 20)
       monmap e1: 1 mons at {ceph1=192.168.1.94:6789/0}, election epoch 2, quorum 0 ceph1
       osdmap e51: 8 osds: 8 up, 8 in
        pgmap v105: 64 pgs, 1 pools, 0 bytes data, 0 objects
              8550 MB used, 140 GB / 156 GB avail
                    32 active+undersized+degraded
                    32 active+remapped
</code></pre>

    <p><strong>注意：</strong></p>

    <p>这里有一个警告: too few pgs per osd, 因此我们需要修改 <code>pg_num</code> , <code>pgp_num</code> 的数值如下:</p>

    <p><code>ceph osd pool set rbd pg_num 266</code></p>

    <p><code>ceph osd pool set rbd pgp_num 266</code></p>

    <pre><code>  cluster b24d2b17-28f2-419a-923d-e05332e2ea58
   health HEALTH_OK
   monmap e3: 1 mons at {ceph1=192.168.1.94:6789/0}, election epoch 1, quorum 0 ceph1
   mdsmap e2: 0/0/1 up
   osdmap e922: 8 osds: 8 up, 8 in
    pgmap v1788: 532 pgs, 2 pools, 0 bytes data, 0 objects
          8754 MB used, 139 GB / 156 GB avail
               532 active+clean
</code></pre>
  </li>
  <li>
    <p>通过 <code>ceph osd tree</code> 查看osd节点的状态</p>

    <pre><code>  # id	weight	type name	up/down	reweight
  -1	8	root default
  -2	4		host ceph1
  0	1			osd.0	up	1	
  1	1			osd.1	up	1	
  2	1			osd.2	up	1	
  3	1			osd.3	up	1	
  -3	4		host ceph2
  4	1			osd.4	up	1	
  5	1			osd.5	up	1	
  6	1			osd.6	up	1	
  7	1			osd.7	up	1	
</code></pre>
  </li>
</ul>

<h2 id="mds-server">部署MDS Server</h2>

<ul>
  <li>
    <p>Edit <code>/usr/local/etc/ceph/ceph.conf</code> and add a MDS section like so:</p>

    <pre><code>  [mds]
      mds data = /var/lib/ceph/mds/$name
      keyring = /var/lib/ceph/mds/$name/keyring
    
  [mds.0]
      host = ceph1
</code></pre>
  </li>
  <li>
    <p>Create the authentication key(only if you use cephX)</p>

    <p><code>mkdir /var/lib/ceph/mds/mds.0</code></p>

    <p><code>ceph-authtool -–create-keyring -–gen-key -n mds.0 /var/lib/ceph/mds/mds.0/keyring</code></p>
  </li>
  <li>
    <p>Add the capabilities to that keyring. Also ran as root:</p>

    <p><code>ceph auth add mds.0 osd ‘allow *’ mon ‘allow rwx’ mds ‘allow’ -i /var/lib/ceph/mds/mds.0/keyring</code></p>
  </li>
  <li>
    <p>Start the service</p>

    <p><code>/etc/init.d/ceph start mds.0</code></p>
  </li>
  <li>
    <p>如果我们修改了Mon所在主机的IP，通过以下方法修改Mon节点的信息</p>

    <p>1.修改ceph.conf中与Mon相关的IP信息
  2.<code>monmaptool --create --add ceph1 192.168.191.2 --fsid b24d2b17-28f2-419a-923d-e05332e2ea58 /tmp/monmap</code>
  3.<code>ceph-mon --inject-monmap /tmp/monmap --mon-data /var/lib/ceph/mon/ceph-ceph1/</code></p>
  </li>
</ul>

<h2 id="create-a-ceph-filesystem">Create a Ceph Filesystem</h2>

<p>A Ceph filesystem requires at least two RADOS pools, one for data and one for metadata.</p>

<ul>
  <li>
    <p>Create data pool</p>

    <p><code>ceph osd pool create cephfs_data 266</code>  # 266 is the pg_num</p>
  </li>
  <li>
    <p>Create metadata pool</p>

    <p><code>ceph osd pool create cephfs_metadata 266</code> # 266 is the pg_num</p>
  </li>
  <li>
    <p>Create filesystem</p>

    <p><code>ceph fs new &lt;fs_name&gt; &lt;metadata&gt; &lt;data</code></p>
  </li>
</ul>

<p>For example:</p>

<pre><code>`ceph fs new cephfs cephfs_metadata cephfs_data`
</code></pre>

<ul>
  <li>
    <p>Mount ceph fs</p>

    <p><code>sudo mkdir /mnt/cephfs</code></p>

    <p><code>sudo mount -t ceph 192.168.1.1:6789:/ /mnt/cephfs</code></p>
  </li>
  <li>
    <p>To mount the Ceph file system with <code>cephx</code> authentication enabled, you must specify a suer name and a secret.</p>

    <p><code>sudo mount -t ceph 192.168.1.1:6789:/ /mnt/cephfs -o name=admin, secret=AQBOAKVUuKA3CxAAM6+hk7n/8rTJTi5gwoG20w==</code></p>
  </li>
</ul>

<h2 id="section-4">参考文献：</h2>

<ul>
  <li>
    <p>添加或移除mon节点，参考<a href="http://docs.ceph.com/docs/master/rados/operations/add-or-rm-mons/">这里</a></p>
  </li>
  <li>
    <p>添加或移除osd节点，参考<a href="http://docs.ceph.com/docs/master/rados/operations/add-or-rm-osds/">这里</a></p>
  </li>
  <li>
    <p>手动部署Ceph手册：http://ceph.com/docs/master/install/manual-deployment/</p>
  </li>
  <li>
    <p>德哥安装osd过程：http://blog.163.com/digoal@126/blog/static/163877040201411141846487/</p>
  </li>
  <li>
    <p>德哥安装Mon过程：http://blog.163.com/digoal@126/blog/static/163877040201410274232276/</p>
  </li>
  <li>
    <p>部署MDS过程：</p>

    <p>www.sebastien-han.fr/blog/2013/05/13/deploy-a-ceph-mds-server</p>

    <p>https://davespano.wordpress.com/2012/10/17/adding-an-mds-server-to-your-ceph-cluster/</p>
  </li>
  <li>
    <p>整个部署过程以及遇到的问题：</p>

    <p>http://blog.zhaw.ch/icclab/deploy-ceph-and-start-using-it-end-to-end-tutorial-installation-part-13/</p>

    <p>http://blog.zhaw.ch/icclab/deploy-ceph-troubleshooting-part-23/</p>

    <p>http://blog.zhaw.ch/icclab/deploy-ceph-librados-client-part-33/</p>
  </li>
  <li>
    <p>Ceph Osd Reweight： http://cephnotes.ksperis.com/blog/2013/12/09/ceph-osd-reweight</p>
  </li>
  <li>
    <p>http://www.admin-magazine.com/HPC/Articles/Ceph-Maintenance</p>
  </li>
  <li>
    <p>可能遇到的问题：</p>

    <p>http://ceph.com/docs/master/rados/troubleshooting/</p>

    <p>http://ceph.com/docs/next/cephfs/troubleshooting/</p>
  </li>
</ul>

    </div>

    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#ceph-ref">ceph <span>1</span></a></li>
    
  



    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/jekyll/2011/12/29/jekyll-introduction" title="Jekyll Introduction">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next disabled"><a>Next &rarr;</a>
    
    </ul>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2016 Domain
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </div>
    </div>

    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes//bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

